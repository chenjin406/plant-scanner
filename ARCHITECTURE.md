# 废品回收小程序系统架构设计

## 1. 系统概述

### 1.1 技术栈
- **前端**: Uni-app (支持微信小程序、支付宝小程序、H5等多平台)
- **后端**: Node.js + Express
- **数据库**: PostgreSQL
- **缓存**: Redis (可选，用于提升性能)
- **文件存储**: 云存储服务 (阿里云OSS/腾讯云COS)
- **支付**: 微信支付、支付宝支付

### 1.2 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端层 (Uni-app)                        │
├──────────────┬──────────────┬─────────────────────────────┤
│  用户端小程序  │  回收员端小程序 │   管理后台(Web/小程序)      │
└──────┬───────┴──────┬───────┴──────────┬─────────────────┘
       │              │                  │
       └──────────────┼──────────────────┘
                      │
              ┌───────▼───────┐
              │   API Gateway  │
              │   (Express)    │
              └───────┬───────┘
                      │
       ┌──────────────┼──────────────┐
       │              │              │
   ┌───▼───┐     ┌───▼───┐     ┌───▼───┐
   │ 用户   │     │ 订单   │     │ 系统   │
   │ 服务   │     │ 服务   │     │ 服务   │
   └───┬───┘     └───┬───┘     └───┬───┘
       │              │              │
       └──────────────┼──────────────┘
                      │
              ┌───────▼───────┐
              │  PostgreSQL   │
              │   Database    │
              └───────────────┘
```

## 2. 系统模块设计

### 2.1 用户端核心模块

#### 2.1.1 用户认证模块
- 手机号+短信验证码登录
- 微信/支付宝授权登录
- 个人信息管理

#### 2.1.2 废品下单模块
- 选择废品类别
- 拍照上传
- 填写重量/数量估算
- 选择上门地址
- 预约时间
- 选择回收员(可选)或系统自动分配

#### 2.1.3 订单管理模块
- 订单列表(待接单、待上门、已完成、已取消)
- 订单详情查看
- 实时订单状态跟踪
- 订单取消
- 订单评价

#### 2.1.4 地址管理模块
- 添加/编辑/删除地址
- 设置默认地址
- 地址定位选择

#### 2.1.5 钱包模块
- 余额查看
- 收入明细
- 提现功能

#### 2.1.6 个人中心
- 个人信息编辑
- 订单历史统计
- 收入统计
- 我的评价

### 2.2 回收员端核心模块

#### 2.2.1 回收员认证
- 实名认证
- 工作区域设置
- 工作状态切换(在线/离线)

#### 2.2.2 订单接收模块
- 接收系统分配订单
- 查看待接单列表
- 订单抢单
- 接单/拒单

#### 2.2.3 订单处理模块
- 待处理订单列表
- 订单详情(用户地址、联系方式、废品信息)
- 导航到用户地址
- 到达用户地点签到
- 废品称重/确认
- 价格确认
- 完成订单

#### 2.2.4 收入管理
- 今日收入统计
- 收入明细
- 提现申请

#### 2.2.5 个人中心
- 个人信息
- 服务区域设置
- 工作统计
- 评价管理

### 2.3 管理端核心模块

#### 2.3.1 用户管理
- 用户列表
- 用户详情
- 用户状态管理(正常/禁用)
- 用户数据统计

#### 2.3.2 回收员管理
- 回收员列表
- 回收员审核
- 回收员认证信息审核
- 回收员状态管理
- 服务区域分配
- 绩效统计

#### 2.3.3 订单管理
- 订单列表(全部状态)
- 订单详情查看
- 订单纠纷处理
- 订单统计报表

#### 2.3.4 废品分类管理
- 分类列表
- 添加/编辑/删除分类
- 分类图标管理
- 分类排序

#### 2.3.5 价格管理
- 价格列表
- 按分类设置价格
- 按区域设置价格
- 价格历史记录

#### 2.3.6 财务管理
- 平台收入统计
- 用户提现审核
- 回收员提现审核
- 财务报表

#### 2.3.7 系统配置
- 基础配置
- 支付配置
- 短信配置
- 云存储配置

#### 2.3.8 数据分析
- 订单趋势分析
- 用户增长分析
- 回收员效率分析
- 废品分类占比分析
- 区域热力图

## 3. 核心业务流程

### 3.1 订单流程

```
用户下单 → 系统分配/用户选择回收员 → 回收员接单
    → 回收员前往 → 到达签到 → 废品称重确认
    → 价格确认 → 完成订单 → 用户评价 → 结算
```

#### 订单状态流转:
1. `pending` - 待接单
2. `accepted` - 已接单
3. `in_progress` - 进行中(回收员已出发)
4. `arrived` - 已到达
5. `completed` - 已完成
6. `cancelled` - 已取消
7. `dispute` - 纠纷中

### 3.2 支付结算流程

```
订单完成 → 平台确认金额 → 资金进入用户账户余额
    → 用户申请提现 → 管理员审核 → 提现到账
```

### 3.3 回收员分配算法

**自动分配策略**:
1. 优先匹配在线状态回收员
2. 服务区域匹配
3. 按距离由近到远排序
4. 考虑回收员当前订单量
5. 考虑回收员评分
6. 推送给前3名回收员，先接单者获得订单

## 4. 非功能性需求

### 4.1 性能要求
- 接口响应时间 < 500ms
- 订单并发处理能力 > 1000/秒
- 支持10万+用户同时在线

### 4.2 安全要求
- HTTPS加密传输
- JWT token认证
- 敏感数据加密存储
- SQL注入防护
- XSS防护
- CSRF防护

### 4.3 可用性要求
- 系统可用性 99.9%
- 数据备份策略
- 灾难恢复方案

## 5. 技术选型理由

### 5.1 Uni-app
- 一套代码多端运行
- 降低开发成本
- 生态完善，组件丰富

### 5.2 Node.js + Express
- 开发效率高
- JavaScript全栈
- 异步非阻塞IO适合高并发
- 生态完善

### 5.3 PostgreSQL
- 开源免费
- ACID事务支持
- JSON数据类型支持
- 地理位置查询支持(PostGIS)
- 强大的查询优化器
